#!/usr/bin/make -f

mk := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
out := new-blog.$(shell date +%Y-%m-%d.%s)
author := $(if $(USER),$(USER),Simple Simon)
post.dest := $(out)/$(shell date +%Y/%m/%d)/0001.md
out.fts := $(out)/fts

.PHONY: new
new:
	$(shell mkdir -p $(dir $(post.dest)) $(out)/pages)
	$(file > $(out)/avatar.svg,$(avatar.svg))
	$(file > $(out)/config,$(config))
	$(file > $(post.dest),$(post))
	$(file > $(out)/pages/about.md,$(page_about))
	-cp $(mk)/test/data/shevchenko/* $(out) 2>/dev/null
	sed -i'' 's/avatar.jpg/avatar.svg/' $(out)/footer.ejs
	rm $(out)/avatar.jpg
	mv $(out)/config $(out)/config.json
	echo /fts >> $(out)/.gitignore
	echo _out >> $(out)/.gitignore
	cd $(out) && $(git) 'init blog'

# fts
	$(shell mkdir -p $(out.fts)/lib)
	$(file > $(out.fts)/package.json,$(package.json))
	echo node_modules > $(out.fts)/.gitignore
	cd $(out.fts) && npm i --no-audit
	cd $(out.fts) && $(git) 'init fts'

git = git init && git add . && git commit -m

define config :=
{
    "title": "$(author)'s blog",
    "rss": {
        "baseUrl": "http://example.com/blog/",
        "author": "$(author)"
    }
}
endef

define post :=
---
subject: My First Post
authors: $(author)
tags: meta
---

It has been a while.
endef

define page_about :=
---
subject: About This Blog
---

The rhyme is as follows:

> *Simple Simon* met a pieman,<br>
> Going to the fair;<br>
> Says Simple Simon to the pieman,<br>
> Let me taste your ware.<br>
<br>
> Says the pieman to Simple Simon,<br>
> Show me first your penny;<br>
> Says Simple Simon to the pieman,<br>
> Indeed I have not any.
endef

define package.json :=
{
  "engines": { "node": "11.0.0" },
  "scripts": { "start": "node nbe-fts-server db.sqlite3" },
  "dependencies": {
    "better-sqlite3": "^5.0.1",
    "minimist": "^1.2.0",
    "shell-quote": "^1.6.1"
  }
}
endef

define avatar.svg :=
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="512.000000pt" height="467.000000pt" viewBox="0 0 512.000000 467.000000"
 preserveAspectRatio="xMidYMid meet">
<g transform="translate(0.000000,467.000000) scale(1.000000,-1.000000)"
fill="#000000" stroke="none">
<path d="M201 465 c-17 -9 -41 -39 -46 -58 0 -2 -1 -3 -2 -3 -2 -1 -8 -9 -10
-13 -1 -2 -2 -2 -14 -2 -23 0 -29 -3 -41 -20 -2 -3 -5 -6 -11 -13 -9 -9 2 -25
23 -37 9 -4 12 -7 12 -9 0 -3 6 -6 10 -6 3 1 5 0 7 -7 2 -4 8 -9 14 -10 3 0 5
-1 6 -3 1 -2 9 -3 13 -1 4 2 4 0 1 -4 -5 -8 -8 -9 -13 -8 -3 0 -7 1 -11 1 -3
0 -7 1 -8 1 -4 2 -38 -6 -48 -11 -6 -3 -7 -3 -19 -3 -16 -1 -20 -3 -26 -16 -3
-5 -6 -11 -7 -13 -1 -2 -2 -4 -2 -5 0 -1 -1 -4 -2 -7 -2 -3 -2 -5 -2 -8 1 -4
1 -5 -2 -7 -5 -6 -14 -35 -18 -55 -1 -4 -2 -8 -2 -9 -3 -4 -2 -41 2 -52 2 -4
3 -7 3 -8 0 -1 2 -4 4 -8 2 -3 5 -8 6 -10 1 -2 3 -5 3 -5 1 -1 3 -4 6 -8 2 -3
6 -7 7 -10 6 -8 21 -19 35 -23 5 -2 11 -5 13 -6 2 -2 4 -3 5 -2 1 0 2 0 2 -1
0 -1 1 -2 1 -2 1 0 9 -1 18 -2 20 -1 66 -2 74 0 3 1 9 1 13 1 7 0 8 0 8 2 0 2
2 3 7 5 5 2 6 2 6 1 -2 -5 9 2 18 10 3 3 9 8 13 11 12 10 25 26 30 39 1 3 3 9
5 11 5 11 9 28 11 46 0 6 2 10 2 5 0 -6 9 -13 21 -16 21 -6 35 -13 52 -23 4
-3 10 -7 12 -8 6 -3 6 -4 3 -13 -1 -4 -1 -7 0 -7 2 -2 1 -9 -1 -17 -2 -4 -3
-8 -3 -9 0 -1 0 -2 -1 -3 -2 -1 -1 -5 2 -8 5 -4 13 -4 14 0 1 1 3 2 5 3 2 0 6
1 9 2 3 0 12 2 19 2 9 1 14 2 15 3 3 3 0 4 -16 3 l-15 0 3 4 c2 1 3 4 3 5 0 1
0 3 1 4 0 1 1 4 2 8 1 3 2 8 3 12 5 14 -1 23 -15 24 -4 1 -6 1 -9 3 -4 4 -16
10 -19 10 -2 0 -6 3 -16 14 -9 8 -16 12 -25 14 -12 3 -12 3 -11 8 0 3 0 4 -2
6 -1 1 -2 3 -1 3 0 1 0 3 -1 5 -1 3 -1 3 2 7 2 2 4 5 5 6 1 2 5 3 9 0 2 0 4
-1 4 -1 1 0 2 -2 3 -4 0 -3 1 -5 2 -6 1 0 2 -1 2 -2 1 -2 2 -3 5 -4 3 -1 8 -3
12 -5 11 -3 16 -8 47 -39 7 -8 17 -17 21 -21 8 -7 13 -15 14 -25 1 -4 2 -11 4
-15 4 -12 5 -20 3 -25 -9 -16 19 -16 29 1 2 2 3 3 6 3 2 1 5 2 7 3 3 1 5 2 7
1 3 0 6 2 5 4 -1 2 -6 2 -11 1 -9 -4 -10 -3 -10 5 0 6 -1 8 -3 11 -1 1 -3 6
-5 10 -2 6 -4 9 -7 12 -3 3 -5 6 -5 7 0 1 -1 2 -2 2 -5 1 -12 7 -16 15 -2 4
-6 11 -9 14 -4 4 -8 10 -11 16 -5 11 -19 26 -29 32 -3 2 -6 4 -7 4 -1 1 -3 2
-5 3 -9 2 -13 5 -13 8 0 3 -1 4 -6 9 -15 14 -18 21 -10 27 3 2 11 13 15 19 1
3 6 18 7 23 1 4 8 18 9 18 2 0 1 2 -3 4 l-5 3 -4 -2 c-6 -2 -17 -5 -19 -5 0 1
-4 0 -8 0 -10 -1 -43 -1 -46 0 -3 1 -8 0 -12 -2 -2 -1 -4 -2 -5 -2 -1 0 -20 9
-24 12 -1 1 -4 2 -5 2 -1 1 -4 2 -7 3 -2 1 -9 3 -14 4 -6 0 -12 1 -14 2 -6 0
-4 2 15 9 10 4 14 11 10 19 -3 4 -5 4 -19 4 -12 0 -17 1 -17 5 0 4 15 14 20
15 8 1 27 16 27 22 0 5 -8 13 -14 13 -1 0 -3 1 -4 2 -3 2 -20 2 -36 0 -12 -2
-12 -2 -12 5 0 10 2 36 3 43 l2 6 8 0 c14 1 24 21 11 21 -1 0 -3 1 -5 2 -1 1
-5 3 -7 4 -5 2 -4 2 -8 0z m11 -7 c2 -1 4 -2 6 -2 5 0 3 -10 -2 -13 -5 -3 -14
0 -12 4 1 1 1 3 1 4 -1 2 -5 -2 -5 -5 0 -2 -1 -4 -2 -6 -2 -5 -4 -15 -3 -29
l0 -9 -3 2 c-5 4 -9 4 -22 2 -12 -1 -13 -1 -11 3 1 1 4 7 7 13 5 11 14 22 19
26 1 1 6 4 10 7 8 7 11 7 17 3z m-25 -56 c4 -2 6 -8 6 -14 l1 -5 -8 -1 c-4 0
-10 0 -13 1 -3 0 -9 1 -13 2 -17 2 -15 2 -14 5 6 9 11 11 36 14 1 0 3 -1 5 -2z
m-50 -19 c4 0 13 -2 21 -3 9 -1 21 -2 31 -3 9 0 18 0 20 0 3 -1 4 -1 6 1 6 6
27 2 38 -7 5 -5 -4 -13 -24 -21 -2 0 -4 -1 -5 -2 -2 -1 -5 -3 -7 -5 -4 -5 -4
-5 -7 0 -4 11 -12 17 -20 17 -3 0 -7 1 -10 2 -20 10 -53 2 -58 -13 0 -2 -1 -3
-1 -4 -3 -3 -8 -18 -9 -24 0 -6 -1 -6 -5 -2 -2 2 -4 3 -5 3 0 0 -2 1 -3 2 -1
1 -3 2 -4 2 -3 1 -14 15 -16 21 0 4 2 10 5 12 2 1 4 4 5 6 2 6 7 10 15 14 12
6 14 7 33 4z m35 -22 c2 0 7 -2 11 -3 3 -1 7 -2 10 -3 5 -2 11 -8 15 -16 2 -7
8 -14 12 -15 3 -1 2 -4 -2 -4 -7 -1 -14 1 -14 4 0 2 -3 5 -5 5 -1 0 -1 -1 0
-4 1 -7 1 -7 -4 -9 -6 -2 -14 6 -14 15 0 2 -1 4 -3 5 -3 4 -4 3 -3 -2 1 -2 1
-4 1 -4 -1 -2 -5 -1 -6 1 0 1 -1 3 -2 4 -1 2 -3 5 -4 7 -4 13 -10 18 -21 17
-4 -1 -6 -1 -6 0 3 2 25 4 35 2z m-19 -8 c3 -1 6 -6 7 -12 0 -2 1 -6 3 -9 2
-2 4 -6 4 -7 2 -3 1 -3 6 -2 5 2 6 2 8 -3 1 -2 3 -5 4 -7 10 -8 9 -12 -2 -23
l-9 -9 -2 2 c-4 2 -4 3 0 6 4 2 9 12 9 17 0 6 -1 5 -3 -2 -5 -15 -22 -24 -30
-14 -3 4 -4 5 -5 3 -1 -4 -11 2 -11 6 0 1 -2 5 -4 8 -6 11 -8 23 -5 31 3 7 7
14 10 14 1 0 3 1 6 2 4 2 7 2 14 -1z m-34 -26 c0 -1 1 -6 2 -10 2 -9 1 -11 -3
-6 -3 3 -4 12 -2 14 1 0 1 1 1 2 0 1 0 2 1 2 1 0 1 -1 1 -2z m128 -5 c6 -6 -4
-15 -26 -22 -5 -2 -20 -13 -32 -25 -10 -10 -12 -11 -14 -9 -2 2 8 20 12 23 6
4 11 9 13 14 5 9 12 14 21 14 1 0 2 1 3 2 1 5 19 6 23 3z m-42 -5 c0 -5 -8
-12 -10 -10 -3 2 -1 4 4 6 3 2 4 3 4 4 0 1 0 2 1 2 1 0 1 -1 1 -2z m24 -26 c5
-1 10 -3 10 -3 1 -1 9 -4 18 -7 23 -6 23 -6 19 -18 -4 -10 -8 -18 -16 -25 -8
-9 -8 -9 -14 -6 -2 1 -7 2 -10 3 -24 4 -24 5 -4 17 11 7 16 11 15 11 -2 2 -9
-1 -15 -6 -13 -9 -16 -11 -17 -11 0 0 -3 -2 -5 -4 -5 -5 -10 -7 -25 -9 -7 -1
-17 -3 -22 -4 -4 -1 -9 -1 -10 -1 -2 1 -3 1 -3 0 -1 -1 -2 -1 -3 -1 -1 0 -2
-1 -3 -1 -1 -3 -3 -2 -5 2 -1 2 -3 5 -5 7 -4 4 -4 4 4 5 4 0 8 2 10 2 1 1 4 2
6 2 1 0 5 1 8 2 3 1 8 1 15 1 12 0 14 1 19 5 2 2 6 4 8 5 6 2 19 10 17 11 0 0
-2 -1 -3 -2 -5 -3 -3 0 3 6 4 3 8 7 10 8 4 2 5 4 2 4 -2 0 -7 -3 -14 -10 -6
-5 -7 -6 -10 -6 -3 0 -6 -2 -3 -2 5 0 1 -7 -4 -7 -1 0 -4 -1 -5 -1 -13 -8 -6
10 10 27 8 8 8 8 22 6z m-59 -13 c1 -2 1 -3 -4 -8 -5 -5 -7 -6 -8 -3 -1 4 11
15 12 11z m213 -5 c1 0 0 -4 -2 -8 -1 -4 -3 -11 -4 -15 -3 -12 -12 -29 -16
-29 -3 0 -9 -8 -9 -12 0 -4 -2 -5 -11 -5 -10 0 -30 6 -29 9 1 1 -3 1 -15 0 -8
0 -19 0 -23 0 l-7 0 0 3 c0 12 1 12 15 12 11 0 27 2 39 6 15 4 15 5 -1 2 -39
-6 -47 -6 -38 2 5 5 11 13 14 20 l3 6 -2 2 c-5 5 19 8 27 3 0 -1 3 -1 5 0 2 0
7 1 12 1 4 1 8 1 9 2 1 0 3 -1 3 -2 2 -1 2 -1 5 0 2 1 5 2 9 2 4 0 8 1 9 1 3
1 6 1 7 0z m-191 -2 c-1 -1 -1 -4 -2 -6 -2 -6 -3 -7 -5 -5 -2 3 -1 5 2 9 4 3
6 4 5 2z m96 -4 c5 -5 4 -10 -6 -22 -3 -3 -6 -7 -7 -9 -2 -2 -6 -6 -9 -8 l-5
-3 -2 2 -2 2 5 5 c8 7 21 28 21 34 0 3 2 3 5 -1z m-140 1 c2 -1 6 -2 8 -4 4
-3 8 -4 9 -1 0 3 1 3 6 -1 3 -2 4 -2 6 -1 2 1 3 0 7 -4 7 -7 6 -8 -7 -7 -9 0
-18 -1 -27 -3 -7 -2 -20 -5 -24 -6 -1 0 -4 0 -5 -1 -1 -1 -6 -3 -10 -3 -8 -2
-16 -6 -21 -10 -3 -2 -5 -3 -7 -4 -9 -2 -13 -7 -7 -11 4 -1 11 -1 19 3 5 2 4
-7 -2 -15 -3 -5 -6 -16 -5 -18 2 -4 7 -1 14 10 5 8 6 8 4 0 -2 -10 -1 -18 3
-18 7 0 13 5 15 14 2 6 3 6 3 1 0 -5 2 -8 5 -7 5 2 6 6 6 22 l0 15 2 1 c1 0 5
1 7 2 3 2 8 3 18 4 23 4 25 4 33 6 4 1 9 3 11 4 3 2 3 2 6 0 1 -1 5 -2 8 -3 3
-1 6 -2 7 -2 1 -1 3 -2 5 -2 7 0 12 -1 13 -2 0 -1 1 -1 2 -1 2 0 3 -1 4 -3 2
-5 5 -7 7 -4 1 1 1 1 1 -3 -1 -4 3 -10 6 -10 2 0 7 -5 7 -7 0 -1 1 -4 3 -7 2
-4 5 -15 9 -31 1 -5 2 -36 1 -41 -2 -12 -6 -25 -10 -34 -2 -3 -4 -9 -6 -12 -1
-4 -6 -12 -9 -18 -4 -5 -7 -10 -7 -11 0 -1 -4 -4 -5 -4 0 0 1 3 3 5 1 3 2 6 2
8 0 2 -1 2 -4 -4 -4 -9 -15 -22 -17 -22 -1 0 -7 -3 -14 -6 -21 -12 -24 -13
-41 -13 -8 -1 -20 -1 -27 -2 -24 -2 -39 -2 -51 2 -29 10 -45 16 -52 23 -2 2
-5 4 -5 4 -8 0 -38 52 -36 61 1 1 0 4 0 6 -3 9 -1 43 1 42 2 -1 2 1 2 7 0 13
7 33 19 55 0 1 3 3 6 5 8 4 15 12 8 8 -3 -2 -3 -1 -3 3 1 5 5 12 5 8 0 -3 1
-4 3 -2 1 0 2 1 3 1 1 0 3 1 4 3 2 2 3 2 5 2 3 -1 3 -1 3 1 -1 0 0 1 1 2 2 1
1 2 -2 1 -5 -1 -4 2 2 8 9 9 33 18 58 21 6 1 20 1 24 0z m-80 -12 c2 -2 -2 -5
-5 -4 -3 0 -3 0 -3 -4 -2 -13 -10 -21 -9 -9 1 4 1 8 2 9 1 1 1 3 0 3 -1 2 -3
-1 -4 -6 0 -3 -2 -6 -3 -8 -2 -4 -6 -11 -8 -17 -1 -3 -3 -4 -4 -4 -3 0 -1 10
4 19 2 5 4 9 4 9 0 6 21 15 26 12z m62 -22 c5 -4 8 -11 3 -9 -1 0 -1 -1 0 -4
1 -3 2 -32 1 -32 -1 -1 -2 -1 -2 2 -1 1 -2 5 -2 7 -1 2 -2 5 -2 6 0 4 -2 2 -3
-4 -2 -8 -7 -20 -9 -20 -1 0 0 7 2 15 0 2 1 6 1 7 0 5 -2 3 -3 -3 -2 -12 -3
-15 -5 -19 -2 -5 -3 -3 -2 5 1 8 1 18 0 19 -1 0 -1 1 -1 2 0 4 -2 2 -5 -4 -9
-19 -15 -23 -8 -6 2 5 4 11 6 15 1 3 3 8 5 11 l3 5 -2 2 -2 3 0 -3 c1 -1 0 -2
-1 -3 0 -1 -2 -3 -2 -4 -3 -4 -22 -10 -24 -7 -2 1 1 4 4 5 4 0 12 5 12 6 1 2
6 5 12 6 2 1 7 2 10 3 7 3 10 2 14 -1z m-100 -21 c0 0 -1 -1 -1 -1 -1 0 -1 3
0 4 1 1 2 -1 1 -3z m279 -6 c8 -3 19 -6 25 -6 6 0 8 -2 5 -3 -1 -1 -8 -13 -8
-15 0 -7 -16 -22 -27 -25 -4 0 -6 5 -7 15 -1 8 -4 17 -5 17 -1 0 -1 -1 1 -6 2
-10 1 -10 -5 -1 -5 7 -11 20 -11 23 0 1 1 2 5 2 3 1 7 1 9 1 8 1 13 1 18 -2z
m47 -10 c2 -3 4 -5 8 -7 7 -3 13 -11 8 -11 -3 0 0 -2 5 -5 4 -2 7 -4 7 -4 1
-1 16 -9 18 -9 2 0 16 -14 20 -20 2 -3 5 -7 6 -9 2 -2 3 -5 4 -7 1 -2 1 -4 2
-4 0 0 1 -2 2 -3 1 -2 3 -7 6 -10 2 -3 7 -9 10 -13 4 -5 7 -8 8 -8 2 -1 4 -6
4 -12 0 -4 2 -7 4 -3 1 2 2 1 3 -2 1 -5 -6 -13 -12 -13 -1 0 -5 8 -5 13 -1 3
-2 6 -2 7 -1 1 -3 5 -5 8 -2 3 -6 8 -14 15 -6 6 -13 13 -16 17 -2 3 -5 6 -6 7
-1 1 -2 2 -2 3 0 0 -1 2 -3 3 -1 1 -4 3 -5 5 -1 2 -4 5 -5 6 -4 2 -11 7 -17
11 -1 2 -7 4 -11 6 -14 4 -23 16 -15 19 3 2 3 2 -3 2 -7 0 -11 1 -13 3 -1 2 3
11 7 15 5 5 8 5 12 0z m-61 -37 c0 -1 1 -3 3 -5 l2 -3 4 2 c1 2 4 3 5 3 1 0 4
1 6 2 l3 2 1 -2 c2 -3 1 -7 -1 -13 -5 -9 -3 -10 2 -1 1 3 3 6 4 6 2 0 1 -3 -3
-10 -4 -8 -3 -10 1 -5 2 2 4 4 5 4 4 0 21 -6 25 -9 5 -4 11 -10 11 -12 0 -2 5
-5 13 -9 3 -2 6 -4 7 -5 1 0 2 -1 2 -1 1 0 3 -1 4 -2 0 -1 2 -2 4 -2 4 0 14
-8 15 -11 0 -1 1 -4 1 -6 2 -8 -1 -13 -11 -20 -6 -4 -7 -4 -7 -1 -1 5 -2 17
-1 17 7 0 4 3 -14 14 -2 1 -5 3 -9 6 -4 2 -9 5 -12 7 -4 1 -10 4 -14 6 -4 2
-8 4 -10 5 -2 0 -5 1 -6 2 -2 0 -4 1 -5 1 -2 0 -19 8 -20 9 -4 7 -9 35 -6 33
0 -1 1 -2 1 -2z m121 -66 c1 -1 2 -3 3 -4 3 -2 2 -9 -1 -21 -4 -16 -7 -21 -18
-29 -4 -3 -9 -6 -10 -8 l-3 -2 -1 2 c-2 3 -3 11 -1 11 0 1 2 4 3 7 3 6 3 7 7
7 2 0 9 5 14 12 l4 5 -1 11 c0 12 0 13 4 9z m65 -34 c4 -7 5 -12 4 -16 0 -1
-1 -4 -1 -6 -2 -8 -11 -16 -20 -16 -5 -1 -5 0 -2 12 2 8 2 10 0 10 -1 0 -2 1
-2 4 -1 7 -1 7 6 8 5 0 9 4 9 8 0 3 2 2 6 -4z m-64 -21 c-1 -1 -2 -1 -4 -1 -2
0 -2 0 0 1 2 1 4 1 4 0z m-236 -34 c-3 -1 -29 -3 -28 -2 1 1 11 3 21 3 7 0 9
0 7 -1z"/>
<path d="M142 345 c-1 -1 -1 -2 -1 -3 1 0 5 2 5 4 0 2 -1 1 -4 -1z"/>
<path d="M128 340 c0 -1 0 -1 1 -1 2 0 3 -4 2 -8 -1 -4 -1 -4 -3 -2 -1 1 -2 1
-3 1 0 -1 2 -5 3 -5 2 0 4 -8 3 -11 -1 -4 1 -8 6 -9 2 0 4 -1 5 -1 0 -1 1 -1
1 0 1 1 2 1 3 0 2 -1 3 -1 2 4 0 3 0 4 1 4 0 0 1 1 1 2 0 2 -3 1 -7 -2 -5 -6
-11 -5 -9 1 0 2 0 4 0 7 -1 2 -1 8 -1 12 0 7 -2 12 -5 8z"/>
<path d="M148 338 c-2 -1 -2 -2 0 -4 3 -3 4 -3 4 1 0 3 -2 4 -4 3z"/>
<path d="M148 297 c0 -1 1 -2 2 -2 2 0 2 0 2 2 0 1 -1 2 -2 2 -2 0 -2 0 -2 -2z"/>
<path d="M67 237 c-2 -2 0 -2 3 -1 1 2 1 2 0 2 -1 0 -2 -1 -3 -1z"/>
</g>
</svg>
endef
